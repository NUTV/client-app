Show      = require 'application/models/show'
Episode   = require 'application/models/episode'
moment    = require 'moment'
component = require 'application/components/loader'

controller = {}

# All shows
controller.shows = (req, res) ->
  await Show.findAll(defer(shows))

  shows = shows.filter (show) ->
    return show unless show.name is 'full-frontal' or show.name is 'full-frontal-july-29,-2014'

  data =
    shows: shows

  res.render('index', data)
  return

# A single show page
controller.show = (req, res) ->

  await Show.findByName req.params.name, defer(show)
  await Episode.findAllByShowId show.id , defer(episodes)

  data =
    show: show
    episodes: episodes
    latestEpisode: episodes[0]

  res.render('show', data)
  return


# An episode for a show
controller.episode = (req, res) ->

  await Show.findByName req.params.name, defer(show)
  await Episode.findAllByShowId show.id , defer(episodes)
  await Episode.findByShowIdAndUrlName(show.id, req.params.episode, defer(episode))

  data =
    show: show
    episode: episode
    episodes: episodes

  res.render('episode', data)

#export controller
module.exports = controller
